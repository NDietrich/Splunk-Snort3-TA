# Overview

This repository is a Technology Add-On (known as a TA) for Splunk that allows you to ingest IDS alerts into Splunk from Snort 3 in json format.  This plugin normalizes these alerts conform to the "Network Intrusion Detection" model in the Splunk Common Information Model (CIM), and can be accessed within any app or dashboard that reports Intrusion Detection events (such as Splunk's Enterprise Security).

This TA is released under the GPL v3 license. Please see the [LICENSE](./TA_Snort3_json/LICENSE) file.

This TA can be installed directly from [SplunkBase](https://splunkbase.splunk.com/), or you can use this repository to modify and create a stand-alone version of this TA, or [download the TA](https://github.com/NDietrich/Splunk-Snort3-TA/releases) and install manually. You only need to use this repository if you want to modify the TA yourself, or if you don't want to download the plugin from Splunk directly. In most cases, you should download this TA directly from [SplunkBase](https://splunkbase.splunk.com/) via your local Splunk instance.

# Important Notes
This TA works with json-formatted logs generated by Snort 3, and will not work with logs generated by Snort 2.  Snort 3 is currently a Beta product. It should not be used in production or mission-cricical environments, and has been made available for testing purposes.  Because of this, it is possible that future modifications to Snort 3 will break this plugin. This plugin has been released before the final version of Snort 3 has been finalized to solicit feedback, including feature requests and bug reports.

# Installing This Plugin
(1) Ensure that you have installed Snort 3, and it is correctly outputting alerts in json format.  Please see the [Snort website](https://snort.org/documents) for installation guides (make sure to install Snort 3 instead of Snort 2).  If you are unsure what platform to install Snort on (Linux, Windows, BSD), choose the platform you are most comfortable using.  I have authored some in-depth installation guides for Ubuntu, available on Snort's website, or alternately available at https://SublimeRobots.com/.

(2) In your json output files, make sure that the 'seconds' field is the very first field output for each alert.  The **alert_json** plugin is configured in the **snort.lua** file.  In the example below, you can see the following settings:

- **fields:**  The 'seconds' field is the first field listed (and thus the first field in the output).  The example here is also choosing to output every possible field.  You can probably remove some of these fields after testing to determine if they are necessary, such as the vlan or mpls fields.

- **file:**  We are outputting to a file (the alert_json.txt file).

- **limit:**  Each json file will be 100 MB before it rolls over to a new file (named alert_json.*epochtime*).

    ```
    --- in your snort.lua file
    alert_json =
    {
        fields = 'seconds timestamp action class b64_data dir dst_addr dst_ap dst_port eth_dst eth_len eth_src eth_type gid icmp_code icmp_id icmp_seq icmp_type iface ip_id ip_len msg mpls pkt_gen pkt_len pkt_num priority proto rev rule service sid src_addr src_ap src_port target tcp_ack tcp_flags tcp_len tcp_seq tcp_win tos ttl udp_len vlan',
        file = true,
        limit = 100,
    }
    ```

(3) Install this plugin (TA_Snort3_json) onto all Splunk servers in your infrastructure.  For Servers, use the web-interface to install the plugin through the 'app' menu. For forwarders, you can use a deployment server, use the CLI, or copy the .spl file to **$SPLUNK_HOME/etc/apps/**.  Splunk's [deployment manual](https://docs.splunk.com/Documentation/AddOns/released/Overview/Distributedinstall) has installation guidance.

(4) Configuring the TA: You only need to configure this TA on any Splunk system where you will be collecting log files; Either on a single server (for a stand-alone installation), or where the Splunk Universal Forwarder (UF) is installed.  You need to configure the TA to identify the location your Snort 3 json log files.  Create the following file: `$SPLUNK_HOME/etc/apps/TA_Snort3_json/local/inputs.conf` that has the following content:
```
[monitor:///var/log/snort/*alert_json.txt*]
sourcetype = snort3:alert:json
```
Adjust the path above to point to the folder that stores the **alert_json** log files that snort created.  In this example, the logs are stored in the the **/var/log/snort** folder.  Restart Splunk only on the server where you modified this file (there is no need to restart Splunk on any of the other servers after installing the TA).

(5) Advanced configuration options:  By default, this TA will search sub-directories of the directory specified above, and events are written to the 'main' index. If you need to to change these settings, modify the file you created above (`local/inputs.conf`) and modify it similarly to the following:

    ```
    [monitor:///var/log/snort/*alert_json.txt*]
    sourcetype = snort3:alert:json
    index = another-index-name
    recursive = false
    ```

# Modifying this TA
If you want to make modifications to a git-clone of this repository, you can use the makefile located in the src folder of this repo to generate your own .spl file (the TA archived into a single file).  This makefile has a few different options:

- **clean:** Remove all temp working directories and created .spl files 
- **spl:** Default option. creates the .spl file in this directory, ready for submission to Splunkbase.
- **install:** Same as above, but then extract the TA to the location specified by the APPDIR variable. (install this TA on your local Splunk server for testing). Reboot Splunk server first.      
- **local-spl:** Same as SPL, but don't remove the contents of the 'local' folder. For internal testing.
- **local-install:** Same as 'install', but doesn't remove the contents of the 'local' folder, for testing.

To verify the TA .spl file is valid, you can use Splunk's [AppInspect](http://dev.splunk.com/view/appinspect/SP-CAAAFAM) tool.  

Once you've created the spl file, you can upload it to your Splunk Server through the [web interface](https://docs.splunk.com/Documentation/AddOns/released/Overview/Singleserverinstall), through your deployment server (if using), through the [CLI](https://docs.splunk.com/Documentation/Splunk/latest/Admin/Managingappobjects#Update_an_app_or_add-on_in_the_CLI), or by just copying the .spl file into the app directory on your server ($SPLUNK_HOME/etc/apps/).  This last option is how the 'install' and 'local-install' MAKE targets work.  An overview of deployment options is [available](https://docs.splunk.com/Documentation/Splunk/7.2.1/Admin/Deployappsandadd-ons).

# Verifying your Data is Normalized Correctly
To Verify that Splunk has correctly normalized your data to match the CIM for [Network Intrusion Detection](https://docs.splunk.com/Documentation/CIM/latest/User/IntrusionDetection), you first need a couple of Splunk Add-Ons installed on your search head:

- [Splunk Common Information Model](https://splunkbase.splunk.com/app/1621/)

- [Splunk Datasets Add-on](https://splunkbase.splunk.com/app/3245/)

After installation of these plugins and your Splunk-Snort3-TA, make sure the logged events are in your default index, then:

1. Choose **Search**, and then choose **Datasets**.

2. Choose **Intrusion Detection > IDS Attacks > Network Intrusion Detection**.

3. Choose a time range that includes the events you want.

4. click **summarize fields**.

5. Look for events that aren't fully green. Some won't have any events at all (such as the **dest_** and **dvc_** events).

Alternately, you can check your data with a search:
```
    | datamodel Intrusion_Detection Network_IDS_Attacks search 
    | search sourcetype="snort3:alert:json" 
    | table * 
    | fieldsummary
```
Look for any fields with a different event count from the total number of events for data that's not tagged right.

# Sample JSON Data
in the [sample JSON data](./sample%20JSON%20data/) folder, there are a number of json files from snort3 that contain alerts. You can use the **update_epochtime.sh** bash script in this folder to modify the time of all the events in these json files so that they are fresh (not old).  New copies of the alert files will be created with current epochtime in the filename (to make them obviously different from the original logs).  Copy these modified files to your Splunk server that's collecting the log files to test your settings.

# Requesting Help
Please submit bug and feature requests via [Github](https://github.com/NDietrich/Splunk-Snort3-TA/issues) for this project, or email Noah@SublimeRobots.com.  Please include as much information as possible with your request.  This TA is not professionally supported (it is a volunteer project), so issues may not be fixed immediately, but I will make every effort to reply.